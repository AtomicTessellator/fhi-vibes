# Statistical Sampling

### Thermodynamic sampling via MD simulations

As outlined in [the MD tutorial](3_md_intro.md), MD simulations provide a way to sample phase space in order to obtain thermodynamic expectation values of observables,

$$
\begin{align}
	\langle O \rangle
	=
	\lim_{t_0 \rightarrow \infty} \frac{1}{t_0}
	\int_0^{t_0} {\rm d} t ~
	O \left( \mathbf{R} (t), {\bf P} (t)\right)
	\label{eq:O2}~,
\end{align}
$$

where  $O \left( \mathbf{R} (t), {\bf P} (t) \right)$ denotes the instantaneous value of the observable $O$ obtained for the phase-space configuration $\{{\bf R} (t),  {\bf P} (t) \}$ evaluated with respect to the the full many-body Hamiltonian $\mathcal H ({\bf P}, {\bf R})$. For example, $O$ could be the instantaneous pressure given by

$$
\begin{align}
\def\d\{{\rm d}}
p({\bf R}, {\bf P}) 
	= - \left. \left( \frac{\d \mathcal H ({\bf R}, {\bf P})}{\d V} \right)\right|_T
	= \frac{1}{3V} \sum_I \frac{{\bf P}_I^2}{M_I} 
	+ \frac{1}{V} \frac{\d \mathcal V ({\bf R})}{\d V}
	~,
	\label{eq:p}
\end{align}
$$

where $\d / \d V$ denotes a volume derivative. For evaluating the thermodynamic expectation value of Eq. $\eqref{eq:p}$, we first note that $p$ decouples into two contributions

$$
\begin{align}
	p({\bf R}, {\bf P}) = p_{\rm Kin} ({\bf P}) + p_{\rm Pot} ({\bf R})~
	\label{eq:p2}
\end{align}
$$

which can be evaluated independently of each other. We thus have

$$
\begin{align}
	\left\langle p \right\rangle
		= \left\langle p_{\rm Kin} \right\rangle 
		+ \left\langle p_{\rm Pot} \right\rangle~,
	\label{eq:p3}
\end{align}
$$

where $p_{\rm Kin}$ denotes the kinetic ideal gas contribution, which yields the familiar [[HansenMcDonald]](references.md#HansenMcDonald)

$$
\left\langle p_{\rm Kin} \right\rangle = \frac{N k_{\rm B} T}{V}~,
$$

and $p_{\rm Pot}$ denotes the potential contribution which needs to be evaluated for the configurations ${\bf R}(t)$ generated by the equations of motion,

$$
\begin{align}
M_{I} \ddot{\mathbf{R}}_{I}(t)=\mathbf{F}_{I}(t)=-\nabla_{I} \mathcal{V}(\mathbf{R}(t))~,
\label{eq:Newton}
\end{align}
$$

so that

$$
\begin{align}
\left\langle p_{\rm Pot} \right\rangle
	= \lim_{N_{\rm t} \rightarrow \infty} \frac{1}{N_{\rm t}}
	\sum_n^{N_{\rm t}} 	
	\frac{1}{V} \frac{\d \mathcal V \left({\bf R} (t_n) \right)}{\d V}
\label{eq:<pPot>}
\end{align}
$$

is a simulation with discrete time steps $t_n$. Since consecutive time steps in an MD simulation are necessarily correlated, Eq. $\eqref{eq:<pPot>}$ can converge quite slowly with the number of time steps $N_{\rm t}$.

### Circumventing the dynamical propagation by generating Monte Carlo samples

In MD simulations, the many-body potential $\mathcal V$ needs to be evaluated _both_ for propagating the dynamical evolution of the system, and for evaluating the observable along the trajectory. On a conceptual level, only the evaluation of the observable is necessary to provide an estimate of the thermodynamic expectation value _if representative samples can be generated by other means_.

Following [[West2006]](references.md#West2006), we now present a way to create these samples based on the [harmonic approximation](2_phonopy_intro.md). In this approximation, the potential is given by

$$
\begin{align}
	\mathcal V^{(2)} ({\bf R}) 
	= \frac{1}{2} \sum_{I, J}
		\Delta {\bf R}_I \cdot \Phi_{IJ} \Delta {\bf R}_J~,
	\label{eq:V2}
\end{align}
$$

with the $3 \times 3$ force constant matrices $\Phi_{IJ}$ and atomic displacements $\Delta {\bf R}_I$. Equation $\eqref{eq:Newton}$ therefore reads

$$
\begin{align}
\left(
\begin{array}{c}
M_{1} \Delta \ddot{\mathbf{R}}_{1} \\
M_{2} \Delta \mathbf{R}_{2} \\
\vdots \\
M_{N} \Delta \ddot{\mathbf{R}}_{N}
\end{array}\right)=\left(\begin{array}{cccc}
\Phi_{11} & \Phi_{12} & \cdots & \Phi_{1 N} \\
\Phi_{21} & \Phi_{22} & \cdots & \Phi_{2 N} \\
\vdots & \vdots & \ddots & \vdots \\
\Phi_{N 1} & \Phi_{N 2} & \cdots & \Phi_{N N}
\end{array}\right)\left(\begin{array}{c}
\Delta \mathbf{R}_{1} \\
\Delta \mathbf{R}_{2} \\
\vdots \\
\Delta \mathbf{R}_{N}
\end{array}\right)~,
\end{align}
$$

and can be solved analytically, yielding

$$
\begin{align}
\Delta {\bf R}_I (t) 
	= \frac{1}{\sqrt{M_I}} \sum_s {\bf e}_{sI} A_s \sin (\omega_s t + \phi_s)~,
\label{eq:R2(t)}
\end{align}
$$

where ${\bf e}_{sI}$ denotes the eigenvector of the dynamical matrix $D_{IJ} = \Phi_{IJ} / \sqrt{M_I M_J}$ corresponding to atom $I$ and phonon mode $s$ and $\omega_s$ the respective frequency, cf. [the phonon tutorial](2_phonopy_intro.md#phonons-harmonic-vibrations-in-solids). The amplitudes $A_s$ and phases $\phi_s$ are fixed by the initial condition $\{{\bf R} (t_0), {\bf P} (t_0) \}$, where in thermal equilibrium [[Dove1993]](references.md#Dove1993)

$$
\begin{align}
\left\langle A_{s}\right\rangle
	=
	\sqrt{
	\frac{\hbar}{\omega_{s}}\left(n_{\mathrm{B}}(\omega_s, T)+\frac{1}{2}\right) 
	}
	~\stackrel{k_{\rm B} T \,\gg\, \hbar \omega_s}{\longrightarrow}~
	\frac{\sqrt{2 k_{\rm B} T}}{\omega_s}~.
	\label{eq:As}
\end{align}
$$

Noting that $\sin (\omega_s t + \phi_s)$ is essentially a random number in $[-1, 1]$, and mimicking thermal fluctuations, samples can be generated by

$$
\begin{align}
\Delta {\bf R}_{I} (n)
	=\frac{1}{\sqrt{M_{I}}} \sum_{s} \zeta_{s} (n) \left\langle A_{s}\right\rangle {\bf e}_{s I}~,
\label{eq:samples}
\end{align}
$$

where $\langle A_s \rangle$ is given by Eq. $\eqref{eq:As}$ and each $\zeta_s (n)$ is a normally distributed random number, where  $n$ labels the sample.

## Example: Lj Argon at 20K

### Obtain force constants

```

```



### Run MD

### Create and calculate samples

### Compare sampling vs. MD